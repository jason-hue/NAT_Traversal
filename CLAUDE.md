# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a cross-platform NAT traversal software written in Rust, consisting of a server and client architecture. The server runs on a public server to facilitate connections, while the client runs on local machines behind NAT to expose local services.

## Architecture

The project is organized as a Cargo workspace with the following components:

- **common/**: Shared protocol definitions, configuration, and utilities
- **server/**: Server-side application that manages client connections and tunnels
- **client/**: Client-side application with both CLI and GUI interfaces
- **platform/**: Platform-specific integrations (Windows services, Linux systemd)

## Key Technologies

- **Async Runtime**: tokio for all async operations
- **TLS Security**: rustls for encrypted communications
- **GUI Framework**: egui for cross-platform client interface
- **Serialization**: serde with JSON for protocol messages, TOML for configuration
- **Logging**: tracing with structured logging

## Build and Development Commands

### Build Commands
```bash
# Build entire workspace (Linux)
cargo build

# Build without GUI (avoids GTK dependencies)
cargo build -p nat-traversal-client --no-default-features

# Build specific components
cargo build -p nat-traversal-server
cargo build -p nat-traversal-client
cargo build -p nat-traversal-common
cargo build -p nat-traversal-platform

# Build for release
cargo build --release

# Cross-compile for Windows (requires mingw toolchain)
cargo build --target x86_64-pc-windows-gnu --release

# Build Windows GUI client specifically
cargo build --target x86_64-pc-windows-gnu -p nat-traversal-client --release
```

### Cross-Platform Build Requirements

#### Linux Build Requirements
```bash
# For GUI client (egui/GTK dependencies)
sudo apt update
sudo apt install -y libgtk-3-dev libatk1.0-dev libcairo-gobject2 \
  libcairo2-dev libgdk-pixbuf2.0-dev libgio2.0-cil-dev \
  libglib2.0-dev libpango1.0-dev pkg-config

# For cross-compilation to Windows
sudo apt install gcc-mingw-w64-x86-64
rustup target add x86_64-pc-windows-gnu
```

#### Windows Build Requirements
```powershell
# For GUI client, no additional system dependencies needed
# rustls and egui are pure Rust implementations
cargo build --release
```

### Feature Flags
```bash
# Client with GUI (default)
cargo build -p nat-traversal-client

# Client without GUI (CLI only)
cargo build -p nat-traversal-client --no-default-features

# Available features:
# - gui: Enables egui-based graphical interface (default)
```

### Running Commands
```bash
# Run server (requires TLS certificates)
cargo run --bin nat-server

# Generate server config
cargo run --bin nat-server -- --generate-config

# Run client with GUI
cargo run --bin nat-client

# Run client in CLI mode
cargo run --bin nat-client -- --no-gui

# Generate client config
cargo run --bin nat-client -- --generate-config
```

### Testing
```bash
# Run all tests (excludes GUI components on systems without GTK)
cargo test -p nat-traversal-common -p nat-traversal-server -p nat-traversal-platform

# Test client without GUI
cargo test -p nat-traversal-client --no-default-features

# Test specific crate
cargo test -p nat-traversal-common
```

## Compilation Status and Known Issues

### ‚úÖ Successfully Compiling Components
- `nat-traversal-common`: Core protocol and utilities
- `nat-traversal-server`: Server binary with TLS support  
- `nat-traversal-platform`: Cross-platform service integration
- `nat-traversal-client`: CLI client (without GUI)

### ‚ö†Ô∏è Platform-Specific Requirements
- **Linux GUI**: Requires GTK development libraries
- **Windows Cross-compilation**: Requires mingw-w64 toolchain
- **TLS Support**: Uses rustls (pure Rust, no OpenSSL dependency)

### üîß Fixed Compilation Issues
1. **Dependencies**: Added missing `tracing-appender`, `webpki-roots`, `hex`, `libc`
2. **TLS Types**: Fixed `tokio_rustls::TlsStream` type mismatches between client/server
3. **API Updates**: Updated deprecated `add_server_trust_anchors` to `add_trust_anchors`
4. **Conditional Compilation**: Added `#[cfg(feature = "gui")]` for optional GUI features
5. **Import Cleanup**: Removed unused imports and fixed module dependencies

### üì¶ Binary Outputs
```bash
# Linux binaries
./target/release/nat-server          # Server executable
./target/release/nat-client          # Client executable (CLI mode)

# Windows binaries (after cross-compilation)
./target/x86_64-pc-windows-gnu/release/nat-server.exe
./target/x86_64-pc-windows-gnu/release/nat-client.exe
```

## Configuration

### Server Configuration (server.toml)
- Network binding and port settings
- TLS certificate paths
- Authentication tokens
- Rate limiting and connection limits

### Client Configuration (client.toml)
- Server connection details
- Tunnel configurations
- GUI preferences
- Logging settings

## Protocol Architecture

The system uses a custom binary protocol over TLS:

1. **Authentication**: Token-based auth with client IDs
2. **Tunnel Management**: Create/close tunnels with port mapping
3. **Data Forwarding**: Bidirectional data transfer through established tunnels
4. **Health Monitoring**: Ping/pong heartbeat and status reporting

## Cross-Platform Considerations

- **TLS**: Uses rustls (pure Rust) to avoid OpenSSL dependencies
- **GUI**: egui provides native look and feel on Windows/Linux
- **Services**: Platform-specific service integration via platform/ crate
- **Configuration**: Uses directories crate for platform-appropriate config paths

## Key Design Patterns

- **Async Message Passing**: All components communicate via mpsc channels
- **Shared State**: Arc<RwLock<T>> for thread-safe shared data
- **Error Handling**: Custom error types with anyhow for error propagation
- **Modular Design**: Clear separation between network, GUI, and business logic

## Development Notes

### Build Status Summary
- ‚úÖ **Linux Native**: All components compile successfully
- ‚úÖ **Tests**: All unit tests pass (3 crypto tests in common crate)
- ‚úÖ **CLI Client**: Works without GUI dependencies
- ‚úÖ **GUI Client (Linux)**: Requires GTK system libraries
- ‚úÖ **Windows Cross-compilation**: Successfully generates Windows binaries
- ‚úÖ **Windows GUI Client**: Full GUI support with egui framework

### Successful Windows Compilation
The project successfully cross-compiles to Windows with full GUI support:

**Generated Windows Binaries:**
```bash
./target/x86_64-pc-windows-gnu/release/nat-client.exe    # ~20MB - GUI Client
./target/x86_64-pc-windows-gnu/release/nat-server.exe    # ~11MB - Server
```

**Windows Compilation Requirements:**
- `gcc-mingw-w64-x86-64` toolchain
- `x86_64-pc-windows-gnu` Rust target
- All dependencies are pure Rust (no external DLLs needed)

**Fixed Windows-specific Issues:**
1. **egui API Compatibility**: Updated from `ViewportBuilder` to `initial_window_size`
2. **winapi Features**: Added explicit winapi dependency with required features
3. **Borrowing Issues**: Resolved mutable borrow conflicts in GUI code
4. **TLS Integration**: Full rustls support without OpenSSL dependencies

### TLS Certificate Requirements
The server requires TLS certificates for all connections. Here are the setup methods:

#### Development Certificate (Self-Signed)
```bash
# Method 1: Simple self-signed certificate
openssl genrsa -out server.key 2048
openssl req -new -x509 -key server.key -out server.crt -days 365 \
  -subj "/C=US/ST=State/L=City/O=NAT-Traversal/CN=localhost"

# Method 2: Certificate with SAN (Subject Alternative Names)
# Create config file first:
cat > server.conf << EOF
[req]
distinguished_name = req_distinguished_name
x509_extensions = v3_req
prompt = no

[req_distinguished_name]
C = US
ST = State  
L = City
O = NAT-Traversal
CN = localhost

[v3_req]
basicConstraints = CA:FALSE
keyUsage = keyEncipherment, dataEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1 = localhost
DNS.2 = YOUR_SERVER_IP
IP.1 = 127.0.0.1
IP.2 = YOUR_SERVER_IP
EOF

# Generate certificate with SAN
openssl genrsa -out server.key 2048
openssl req -new -x509 -key server.key -out server.crt -days 365 -config server.conf
```

#### Production Certificate
For production environments, use certificates from a trusted CA like Let's Encrypt.

#### TLS Verification Settings
- **Development**: Set `tls_verify = false` in client config for self-signed certificates
- **Production**: Set `tls_verify = true` and use proper CA-signed certificates

**Important**: The client requires the `dangerous_configuration` feature for rustls to disable certificate verification in development mode.

### Feature Flag Architecture
The client supports conditional compilation:
- **Default**: Includes GUI support (requires system dependencies)
- **CLI-only**: `--no-default-features` for headless environments
- **GUI**: `--features gui` to explicitly enable GUI components

### Common Development Issues
1. **GTK Missing**: Use `--no-default-features` for client or install GTK dev libraries
2. **Windows Cross-compilation**: Install `gcc-mingw-w64-x86-64` package
3. **TLS Errors**: Ensure certificates are properly configured in config files
4. **Config Generation**: Check `~/.config/nat-traversal/` for generated config files

### Code Quality
- All components compile with only minor warnings (unused code)
- Memory safety guaranteed by Rust's ownership system
- Async architecture throughout for high performance
- Error handling via custom `NatError` type with anyhow integration

## WSL + Windows ÈÉ®ÁΩ≤ÊåáÂçó

ËøôÊòØ‰∏Ä‰∏™Â∏∏ËßÅÁöÑÂºÄÂèëÂú∫ÊôØÔºöÂú®WSL‰∏≠ËøêË°åserverÔºåÂú®WindowsÂÆø‰∏ªÊú∫‰∏≠ËøêË°åclient„ÄÇ

### ÁéØÂ¢ÉÂáÜÂ§á

#### WSL Á´Ø (Server)
```bash
# ÂÆâË£ÖÂøÖË¶ÅÁöÑÊûÑÂª∫Â∑•ÂÖ∑
sudo apt update
sudo apt install -y gcc-mingw-w64-x86-64 build-essential pkg-config

# Ê∑ªÂä† Windows ÁºñËØëÁõÆÊ†á
rustup target add x86_64-pc-windows-gnu

# Ëé∑Âèñ WSL IP Âú∞ÂùÄ
ip addr show eth0 | grep 'inet ' | awk '{print $2}' | cut -d'/' -f1
# Á§∫‰æãËæìÂá∫: 172.22.247.72
```

#### Windows Á´Ø (Client)
Êó†ÈúÄÈ¢ùÂ§ñÂÆâË£ÖÔºåÁºñËØëÂêéÁöÑ exe Êñá‰ª∂ÂèØÁõ¥Êé•ËøêË°å„ÄÇ

### ÈÉ®ÁΩ≤Ê≠•È™§

#### 1. ÊûÑÂª∫ Server Á´Ø
```bash
# ÁîüÊàê server ÈÖçÁΩÆ
cargo run --bin nat-server -- --generate-config

# ÊûÑÂª∫ server (release Ê®°ÂºèÊé®Ëçê)
cargo build --bin nat-server --release
```

#### 2. ÈÖçÁΩÆ Server
ÁºñËæë `~/.config/nat-traversal/server.toml`:
```toml
[network]
bind_addr = "WSL_IP_ADDRESS"  # ÊõøÊç¢‰∏∫ÂÆûÈôÖÁöÑWSL IP
port = 7000
max_connections = 1000

[tls]
cert_path = "/path/to/server.crt"  # ‰ΩøÁî®ÁªùÂØπË∑ØÂæÑ
key_path = "/path/to/server.key"   # ‰ΩøÁî®ÁªùÂØπË∑ØÂæÑ
verify_client = false

[auth]
tokens = ["your-secret-token"]  # ‰ΩøÁî®ÂÆâÂÖ®ÁöÑtoken
require_auth = true
max_clients_per_token = 10
```

#### 3. ÁîüÊàê TLS ËØÅ‰π¶
```bash
# ÂàõÂª∫ÂåÖÂê´WSL IPÁöÑËØÅ‰π¶ÈÖçÁΩÆ
cat > server-wsl.conf << EOF
[req]
distinguished_name = req_distinguished_name
x509_extensions = v3_req
prompt = no

[req_distinguished_name]
C = US
ST = State  
L = City
O = NAT-Traversal
CN = localhost

[v3_req]
basicConstraints = CA:FALSE
keyUsage = keyEncipherment, dataEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1 = localhost
IP.1 = 127.0.0.1
IP.2 = WSL_IP_ADDRESS  # ÊõøÊç¢‰∏∫ÂÆûÈôÖÁöÑWSL IP
EOF

# ÁîüÊàêËØÅ‰π¶
openssl genrsa -out server.key 2048
openssl req -new -x509 -key server.key -out server.crt -days 365 -config server-wsl.conf
```

#### 4. ‰∫§ÂèâÁºñËØë Windows Client
```bash
# ÁºñËØë Windows GUI ÂÆ¢Êà∑Á´Ø
cargo build --target x86_64-pc-windows-gnu -p nat-traversal-client --release

# ÁîüÊàêÂÆ¢Êà∑Á´ØÈÖçÁΩÆ
cargo run --bin nat-client -- --generate-config
```

#### 5. ÈÖçÁΩÆ Client
ÁºñËæë `~/.config/nat-traversal/client.toml`:
```toml
[server]
addr = "WSL_IP_ADDRESS"  # WSLÊúçÂä°Âô®Âú∞ÂùÄ
port = 7000
token = "your-secret-token"  # ‰∏éserverÈÖçÁΩÆ‰∏≠ÁöÑtokenÂåπÈÖç
client_id = "windows-client"
auto_reconnect = true
reconnect_interval_secs = 30
tls_verify = false  # ÂºÄÂèëÁéØÂ¢ÉÁ¶ÅÁî®ËØÅ‰π¶È™åËØÅ

[gui]
enabled = true
start_minimized = false
system_tray = true
theme = "dark"

[logging]
level = "info"
max_size_mb = 50
max_files = 3
```

#### 6. ÈÉ®ÁΩ≤Âà∞ Windows
```bash
# Â§çÂà∂ÂøÖË¶ÅÊñá‰ª∂Âà∞WindowsÂèØËÆøÈóÆÁöÑ‰ΩçÁΩÆ
cp ./target/x86_64-pc-windows-gnu/release/nat-client.exe /mnt/c/temp/
cp ~/.config/nat-traversal/client.toml /mnt/c/temp/
```

### ËøêË°åÊåáÂçó

#### ÂêØÂä® Server (WSL)
```bash
# ÂâçÂè∞ËøêË°å (Áî®‰∫éË∞ÉËØï)
./target/release/nat-server

# ÂêéÂè∞ËøêË°å
nohup ./target/release/nat-server > server.log 2>&1 &

# ‰ΩøÁî® systemd ÊúçÂä° (Êé®Ëçê)
# ÂèÇËÄÉ platform/ ÁõÆÂΩï‰∏≠ÁöÑÊúçÂä°ÈÖçÁΩÆ
```

#### ÂêØÂä® Client (Windows)
```powershell
# GUI Ê®°Âºè (ÂèåÂáªËøêË°åÊàñÂëΩ‰ª§Ë°å)
.\nat-client.exe

# CLI Ê®°Âºè
.\nat-client.exe --no-gui

# ÊåáÂÆöÈÖçÁΩÆÊñá‰ª∂
.\nat-client.exe --config client.toml
```

### ÁΩëÁªúÈÖçÁΩÆ

#### WSL ÁΩëÁªúËÆøÈóÆ
WSL2 ‰ΩøÁî®ËôöÊãüÁΩëÁªúÔºåWindows ÂÆø‰∏ªÊú∫ÂèØ‰ª•Áõ¥Êé•ËÆøÈóÆ WSL IPÔºå‰ΩÜÈúÄË¶ÅÁ°Æ‰øùÔºö
1. WSL IP Âú∞ÂùÄÂèØËÉΩÂú®ÈáçÂêØÂêéÊîπÂèòÔºåÈúÄË¶ÅÊõ¥Êñ∞ÈÖçÁΩÆ
2. Windows Èò≤ÁÅ´Â¢ôÂÖÅËÆ∏ËÆøÈóÆÊåáÂÆöÁ´ØÂè£ (7000)
3. WSL ‰∏≠ÁöÑ iptables ‰∏çÈòªÊ≠¢ËøûÊé•

#### Èò≤ÁÅ´Â¢ôÈÖçÁΩÆ
```bash
# WSL Á´ØÊ£ÄÊü•Èò≤ÁÅ´Â¢ô (Â¶ÇÊûúÂêØÁî®)
sudo ufw status
sudo ufw allow 7000

# Windows Á´ØÊ∑ªÂä†Èò≤ÁÅ´Â¢ôËßÑÂàô (ÁÆ°ÁêÜÂëòÊùÉÈôê)
netsh advfirewall firewall add rule name="NAT Traversal Client" dir=out action=allow protocol=TCP localport=7000
```

### ÊïÖÈöúÊéíÈô§

#### Â∏∏ËßÅÈóÆÈ¢ò
1. **ËøûÊé•Ë¢´ÊãíÁªù**: Ê£ÄÊü• WSL IP Âú∞ÂùÄÊòØÂê¶Ê≠£Á°ÆÔºåserver ÊòØÂê¶Ê≠£Âú®ËøêË°å
2. **TLS Êè°ÊâãÂ§±Ë¥•**: Á°Æ‰øùËØÅ‰π¶ÂåÖÂê´Ê≠£Á°ÆÁöÑ IP Âú∞ÂùÄÔºåÊàñËÆæÁΩÆ `tls_verify = false`
3. **ËÆ§ËØÅÂ§±Ë¥•**: Ê£ÄÊü• server Âíå client ÁöÑ token ÊòØÂê¶‰∏ÄËá¥
4. **WSL IP ÂèòÂåñ**: ‰ΩøÁî®ËÑöÊú¨Ëá™Âä®Êõ¥Êñ∞ÈÖçÁΩÆÊàñËÄÉËôë‰ΩøÁî®Á´ØÂè£ËΩ¨Âèë

#### Ë∞ÉËØïÂëΩ‰ª§
```bash
# Ê£ÄÊü• server ÊòØÂê¶ÁõëÂê¨
ss -tlnp | grep 7000

# ÊµãËØïÁΩëÁªúËøûÊé•
telnet WSL_IP_ADDRESS 7000

# Êü•ÁúãËØ¶ÁªÜÊó•Âøó
RUST_LOG=debug ./target/release/nat-server
RUST_LOG=debug ./nat-client.exe --no-gui
```

### Ëá™Âä®ÂåñËÑöÊú¨Á§∫‰æã
```bash
#!/bin/bash
# wsl-setup.sh - Ëá™Âä®ËÆæÁΩÆWSLÊúçÂä°Âô®

WSL_IP=$(ip addr show eth0 | grep 'inet ' | awk '{print $2}' | cut -d'/' -f1)
echo "WSL IP: $WSL_IP"

# Êõ¥Êñ∞serverÈÖçÁΩÆ
sed -i "s/bind_addr = .*/bind_addr = \"$WSL_IP\"/" ~/.config/nat-traversal/server.toml

# Êõ¥Êñ∞clientÈÖçÁΩÆ
sed -i "s/addr = .*/addr = \"$WSL_IP\"/" ~/.config/nat-traversal/client.toml

# ÈáçÊñ∞ÁîüÊàêËØÅ‰π¶
openssl genrsa -out server.key 2048
openssl req -new -x509 -key server.key -out server.crt -days 365 \
  -subj "/C=US/ST=State/L=City/O=NAT-Traversal/CN=localhost" \
  -addext "subjectAltName=IP:127.0.0.1,IP:$WSL_IP"

echo "Configuration updated for WSL IP: $WSL_IP"
```

## Security Features

- Mandatory TLS encryption for all communications
- Token-based authentication
- Port range restrictions for tunnels
- Connection rate limiting
- Certificate verification (configurable)